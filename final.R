#主題----

# 根據您提供的資料集，以下是幾個可能的主題分析建議：
# 1. **縣市用電趨勢分析**：
# - 分析不同縣市在不同時間點的用電量變化。
# - 可以探討住宅、服務業、農林漁牧和工業部門用電量的變化趨勢。
# 
# 2. **用電結構變化分析**：
# - 分析不同部門（住宅、服務業、農林漁牧、工業）的用電佔比變化。
# - 探討用電結構隨時間的變化，是否有某個部門的用電佔比逐漸增加或減少。
# 
# 3. **用電佔比的地區比較**：
# - 比較不同縣市在相同時間點上的用電佔比。
# - 分析不同縣市在用電結構上的差異，例如某些縣市的工業部門用電佔比特別高。
# 
# 4. **總用電量和部門用電量的相關性分析**：
# - 分析各縣市總用電量與各部門用電量之間的相關性。
# - 探討哪個部門的用電量對總用電量的影響最大。
# 
# 5. **季節性用電變化分析**：
# - 分析不同縣市在不同季節的用電量變化。
# - 探討季節性因素對不同部門用電量的影響。
# 
# 6. **用電效率分析**：
# - 分析各縣市的用電佔比與其經濟活動的關聯，評估用電效率。
# - 探討哪些縣市在用電上更高效。
# 請確認您對上述分析主題的興趣，或提供更具體的需求，我將根據您的選擇進一步提供R程式碼的實現方法。


# 引入資料----
library(readr)
power_data <- read_csv("台灣電力公司_各縣市住宅、服務業及機關用電統計資料.csv")

# 資料描述 -----

library(tidyverse)
source("tool.R")
summary_data <- first_step(power_data)

# 將用電佔比小數值轉換為百分比----
power_data <- power_data %>%
  mutate(
    `住宅部門用電佔比(%)` = if_else(日期 <= 202212, `住宅部門用電佔比(%)` * 100, `住宅部門用電佔比(%)`),
    `服務業部門(含包燈)用電佔比(%)` = if_else(日期 <= 202212, `服務業部門(含包燈)用電佔比(%)` * 100, `服務業部門(含包燈)用電佔比(%)`),
    `農林漁牧用電佔比(%)` = if_else(日期 <= 202212, `農林漁牧用電佔比(%)` * 100, `農林漁牧用電佔比(%)`),
    `工業部門用電佔比(%)` = if_else(日期 <= 202212, `工業部門用電佔比(%)` * 100, `工業部門用電佔比(%)`)
  )



# 1. **縣市用電趨勢分析**  ----
# - 分析不同縣市在不同時間點的用電量變化。
# - 可以探討住宅、服務業、農林漁牧和工業部門用電量的變化趨勢。
# 載入所需的套件
library(tidyverse)
library(lubridate)
library(stringr)

# 排除縣市中的“合計”行
power_data_outof_total <- power_data %>%
  filter(縣市 != "合計")

# 用電量轉換為萬度度
power_data_outof_total <- power_data_outof_total %>%
  mutate(
    `住宅部門售電量(度)` = `住宅部門售電量(度)` / 1000000,
    `服務業部門(含包燈)(度)` = `服務業部門(含包燈)(度)` / 1000000,
    `農林漁牧售電量(度)` = `農林漁牧售電量(度)` / 1000000,
    `工業部門售電量(度)` = `工業部門售電量(度)` / 1000000
  )

# 分析不同縣市在不同時間點的用電量變化
# 1. 整理住宅部門用電量變化趨勢
住宅部門_趨勢 <- power_data_outof_total %>%
  select(日期, 縣市, `住宅部門售電量(度)`) %>%
  group_by(縣市, 日期) %>%
  summarise(住宅用電量 = sum(`住宅部門售電量(度)`, na.rm = TRUE))

# 顯示整理後的住宅部門用電量變化趨勢
glimpse(住宅部門_趨勢)

# 2. 整理服務業部門用電量變化趨勢
服務業部門_趨勢 <- power_data_outof_total %>%
  select(日期, 縣市, `服務業部門(含包燈)(度)`) %>%
  group_by(縣市, 日期) %>%
  summarise(服務業用電量 = sum(`服務業部門(含包燈)(度)`, na.rm = TRUE))

# 顯示整理後的服務業部門用電量變化趨勢
glimpse(服務業部門_趨勢)

# 3. 整理農林漁牧部門用電量變化趨勢
農林漁牧_趨勢 <- power_data_outof_total %>%
  select(日期, 縣市, `農林漁牧售電量(度)`) %>%
  group_by(縣市, 日期) %>%
  summarise(農林漁牧用電量 = sum(`農林漁牧售電量(度)`, na.rm = TRUE))

# 顯示整理後的農林漁牧部門用電量變化趨勢
glimpse(農林漁牧_趨勢)

# 4. 整理工業部門用電量變化趨勢
工業部門_趨勢 <- power_data_outof_total %>%
  select(日期, 縣市, `工業部門售電量(度)`) %>%
  group_by(縣市, 日期) %>%
  summarise(工業用電量 = sum(`工業部門售電量(度)`, na.rm = TRUE))

# 顯示整理後的工業部門用電量變化趨勢
glimpse(工業部門_趨勢)

# 5. 繪製趨勢圖表
# 住宅部門用電量趨勢圖
住宅部門_趨勢 %>%
  ggplot(aes(x = 日期, y = 住宅用電量, color = 縣市)) +
  geom_line() +
  labs(title = "住宅部門用電量趨勢", x = "日期", y = "用電量(百萬度)")

# 服務業部門用電量趨勢圖
服務業部門_趨勢 %>%
  ggplot(aes(x = 日期, y = 服務業用電量, color = 縣市)) +
  geom_line() +
  labs(title = "服務業部門用電量趨勢", x = "日期", y = "用電量(百萬度)")

# 農林漁牧部門用電量趨勢圖
農林漁牧_趨勢 %>%
  ggplot(aes(x = 日期, y = 農林漁牧用電量, color = 縣市)) +
  geom_line() +
  labs(title = "農林漁牧部門用電量趨勢", x = "日期", y = "用電量(百萬度)")

# 工業部門用電量趨勢圖
工業部門_趨勢 %>%
  ggplot(aes(x = 日期, y = 工業用電量, color = 縣市)) +
  geom_line() +
  labs(title = "工業部門用電量趨勢", x = "日期", y = "用電量(百萬度)")
                          

# 2. **用電結構變化分析**：----------------------------
# - 分析不同部門（住宅、服務業、農林漁牧、工業）的用電佔比變化。
# - 探討用電結構隨時間的變化，是否有某個部門的用電佔比逐漸增加或減少。


power_data_time <- power_data %>%
  filter(縣市 == "合計")

# 用電量轉換為萬度
power_data_time <- power_data_time %>%
  mutate(
    `住宅部門售電量(度)` = `住宅部門售電量(度)` / 1000000,
    `服務業部門(含包燈)(度)` = `服務業部門(含包燈)(度)` / 1000000,
    `農林漁牧售電量(度)` = `農林漁牧售電量(度)` / 1000000,
    `工業部門售電量(度)` = `工業部門售電量(度)` / 1000000,
    `合計售電量(度)` = `合計售電量(度)` / 1000000
  )

# 1. 分析不同部門用電佔比變化
用電佔比_趨勢 <- power_data_time %>%
  select(日期, 縣市, `住宅部門用電佔比(%)`, `服務業部門(含包燈)用電佔比(%)`, `農林漁牧用電佔比(%)`, `工業部門用電佔比(%)`) %>%
  gather(key = "部門", value = "用電佔比", -日期, -縣市)

# 顯示整理後的用電佔比變化趨勢
glimpse(用電佔比_趨勢)

# 2. 繪製用電佔比變化趨勢圖 group = type, color = type
用電佔比_趨勢 %>%
  ggplot(aes(x = 日期, y = 用電佔比, group = 部門 ,color = 部門)) +
  geom_line(size = 0.5) +
  facet_wrap(~ 縣市, ncol = 1) +
  labs(title = "不同部門用電佔比變化趨勢", x = "日期", y = "用電佔比(%)")


# 3. 分析用電結構隨時間的變化
用電結構_變化 <- power_data_time %>%
  group_by(日期) %>%
  summarise(
    住宅用電佔比 = mean(`住宅部門用電佔比(%)`, na.rm = TRUE),
    服務業用電佔比 = mean(`服務業部門(含包燈)用電佔比(%)`, na.rm = TRUE),
    農林漁牧用電佔比 = mean(`農林漁牧用電佔比(%)`, na.rm = TRUE),
    工業用電佔比 = mean(`工業部門用電佔比(%)`, na.rm = TRUE)
  ) %>%
  gather(key = "部門", value = "用電佔比", -日期)

# 顯示整理後的用電結構變化
glimpse(用電結構_變化)

# 繪製用電結構變化趨勢圖
用電結構_變化 %>%
  ggplot(aes(x = 日期, y = 用電佔比, color = 部門)) +
  geom_line() +
  scale_x_continuous(breaks = c(201603, 201606, 201609, 201612, 201703, 201706, 201709, 201712, 201803, 201806, 201809, 201812, 201903, 201906, 201909, 201912, 202003, 202006, 202009, 202012, 202103, 202106, 202109, 202112, 202203, 202206, 202209, 202212, 202300, 202303, 202306, 202309, 202312, 202400),
                     labels = c("201603", "201606", "201609", "201612", "201703", "201706", "201709", "201712", "201803", "201806", "201809", "201812", "201903", "201906", "201909", "201912", "202003", "202006", "202009", "202012", "202103", "202106", "202109", "202112", "202203", "202206", "202209", "202212", "202300", "202303", "202306", "202309", "202312", "20240000")) +
  labs(title = "用電結構隨時間的變化", x = "日期", y = "用電佔比(%)")




















